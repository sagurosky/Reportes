<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="plantillas/plantilla::head">
    <title>Eventos de Carga</title>

</head>
<body>
<link rel="stylesheet"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<header th:replace="plantillas/plantilla::header"></header>
<div class="volver-fijo d-flex justify-content-end px-4 pt-3">
    <a th:href="@{/menuPrincipal}" class="btn btn-primary btn-lg">
        <i class="bi bi-arrow-left-circle"></i> Volver
    </a>
</div>
<div class="container py-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center">
            <h3 class="fw-bold mb-0">ðŸ“‹ Eventos de Carga</h3>
        </div>
        <div class="card-body">
            <table id="tablaEventos" class="table table-striped table-hover align-middle">
                <thead class="table-primary">
                <tr>
                    <th>Archivo</th>
                    <th>Sucursal</th>
                    <th>Fecha de carga</th>
                    <th>Fecha de archivo</th>
                    <th>Usuario</th>
                    <th>MÃ³dulo</th>
                    <th>Estado</th>
                    <th>Observaciones</th>
                    <th>ID Stock Inicial</th>
                    <th>ID Stock Final</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="e : ${eventos}" th:attr="data-evento-id=${e.id}">
                    <td th:text="${e.nombreArchivo}"></td>
                    <td th:text="${e.sucursal.nombre}"></td>
                    <td th:text="${#temporals.format(e.fecha, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${#temporals.format(e.fechaArchivo, 'dd/MM/yyyy')}"></td>
                    <td th:text="${e.usuario}"></td>
                    <td>
                        <span class="badge bg-info text-dark" th:text="${e.modulo}"></span>
                    </td>
                    <td class="estado-td">

                        <div class="progress-wrapper"
                             th:if="${e.estado != 'COMPLETADO'}">
                            <div class="progress">
                                <div class="progress-bar progreso-barra"
                                     role="progressbar"
                                     th:style="'width:' + ${e.porcentaje} + '%'"
                                     th:text="${e.porcentaje + '%'}">
                                </div>
                            </div>
                        </div>

                        <span class="estado-badge"
                              th:classappend="
                                  ${e.estado == 'COMPLETADO'} ? 'badge bg-success' :
                                  (${e.estado == 'FALLIDO'} ? 'badge bg-danger' : 'badge bg-warning text-dark')"
                                                  th:text="${e.estado}">
                        </span>

                    </td>
                    <td th:text="${e.observaciones}" class="observaciones"></td>
                    <td class="stock inicial" th:text="${e.idStockInicial != null ? e.idStockInicial : '-'}"></td>
                    <td class="stock final" th:text="${e.idStockFinal != null ? e.idStockFinal : '-'}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script th:inline="none">
    $(document).ready(function() {
        $('#tablaEventos').DataTable({
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
            },
            order: [[1, 'desc']], // ordenar por fecha descendente
            pageLength: 20,
            responsive: true
        });

       (function () {

            const INTERVALO = 4000;

            function actualizarFila(tr) {
                const eventoId = tr.dataset.eventoId;
                const td = tr.querySelector('.estado-td');

                fetch(`/eventosCarga/${eventoId}/estado`)
                    .then(r => r.json())
                    .then(data => {

                        // ===== Estado (badge) =====
                        const badge = td.querySelector('.estado-badge');
                        badge.innerText = data.estado;

                        badge.className = 'estado-badge badge';
                        if (data.estado === 'COMPLETADO') {
                            badge.classList.add('bg-success');
                        } else if (data.estado === 'FALLIDO') {
                            badge.classList.add('bg-danger');
                        } else {
                            badge.classList.add('bg-warning', 'text-dark');
                        }

                        // ===== Progreso =====
                        const progressWrapper = td.querySelector('.progress-wrapper');
                        const progressBar = td.querySelector('.progreso-barra');

                        if (data.estado !== 'COMPLETADO') {
                            if (progressWrapper && progressBar) {
                                progressBar.style.width = data.porcentaje + '%';
                                progressBar.innerText = data.porcentaje + '%';
                            }
                        } else {
                            // Si completÃ³, ocultamos la barra
                            if (progressWrapper) {
                                progressWrapper.style.display = 'none';
                            }
                            tr.dataset.finalizado = 'true';

                            // ===== Actualizar stock =====
                            const stockInicialTd = tr.querySelector('td.stock.inicial');
                            const stockFinalTd   = tr.querySelector('td.stock.final');

                            if (stockInicialTd) {
                                stockInicialTd.textContent = data.idStockInicial ?? '-';
                            }
                            if (stockFinalTd) {
                                stockFinalTd.textContent = data.idStockFinal ?? '-';
                            }



                        }

                    })
                    .catch(err => console.error('Error polling evento', eventoId, err));
            }

            setInterval(() => {
                document.querySelectorAll('tr[data-evento-id]').forEach(tr => {
                    if (tr.dataset.finalizado !== 'true') {
                        actualizarFila(tr);
                    }

                });
            }, INTERVALO);

        })();

    });

</script>

</body>
</html>
