<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuditorÃ­a de Stock</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body {
            background: url('/recursos/img8.jpg') no-repeat center center fixed;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .card-translucent {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .compliance-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-cumple {
            background-color: #28a745;
            color: white;
        }

        .badge-no-cumple {
            background-color: #dc3545;
            color: white;
        }

        .estado-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .spinner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 15px;
        }

        .section-title {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>

    <header th:replace="plantillas/plantilla::header"></header>

    <div class="volver-fijo d-flex justify-content-end px-4 pt-3">
        <a th:href="@{/menuPrincipal}" class="btn btn-primary btn-lg">
            <i class="bi bi-arrow-left-circle"></i> Volver
        </a>
    </div>

    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="card shadow-lg border-0 mb-4">
            <div th:class="|card-header text-center ${colorClase}|">
                <h2 class="fw-bold mb-0">ðŸ“‹ Dashboard de AuditorÃ­a de Stock</h2>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card-translucent">
            <div class="filter-section">
                <form method="get" th:action="@{/stock/auditoria}" class="row g-3">
                    <input type="hidden" name="color" th:value="${colorClase}" />

                    <div class="col-md-4">
                        <label for="sucursalId" class="form-label fw-bold">
                            <i class="bi bi-building"></i> Sucursal:
                        </label>
                        <select id="sucursalId" name="sucursalId" class="form-select">
                            <option value="">-- Todas las sucursales --</option>
                            <option th:each="suc : ${sucursales}" th:value="${suc.id}" th:text="${suc.nombre}"
                                th:selected="${suc.id == sucursalSeleccionada}">
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="fechaInicio" class="form-label fw-bold">
                            <i class="bi bi-calendar"></i> Fecha Inicio:
                        </label>
                        <input type="date" id="fechaInicio" name="fechaInicio" class="form-control"
                            th:value="${fechaInicio}" required />
                    </div>

                    <div class="col-md-3">
                        <label for="fechaFin" class="form-label fw-bold">
                            <i class="bi bi-calendar-check"></i> Fecha Fin:
                        </label>
                        <input type="date" id="fechaFin" name="fechaFin" class="form-control" th:value="${fechaFin}"
                            required />
                    </div>

                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-funnel"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row mb-4" id="kpiSection">
            <div class="col-md-3">
                <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="kpi-label">Total Cargas</div>
                    <div class="kpi-value" id="kpiTotalCargas">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="kpi-label">Cargas Exitosas</div>
                    <div class="kpi-value" id="kpiCargasExitosas">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                    <div class="kpi-label">Con Errores</div>
                    <div class="kpi-value" id="kpiConErrores">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6610f2 100%);">
                    <div class="kpi-label">% Promedio</div>
                    <div class="kpi-value" id="kpiPromedio">-</div>
                </div>
            </div>
        </div>

        <!-- Compliance Table -->
        <div class="card-translucent position-relative">
            <div id="cumplimientoLoader" class="spinner-overlay" style="display: none;">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <h4 class="section-title">
                <i class="bi bi-clipboard-check"></i> Cumplimiento Diario por Sucursal
            </h4>
            <div class="table-responsive">
                <table class="table table-hover" id="cumplimientoTable">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Sucursal</th>
                            <th>DÃ­a Esperado</th>
                            <th>Cargas</th>
                            <th>Estado</th>
                            <th>Cumplimiento</th>
                        </tr>
                    </thead>
                    <tbody id="cumplimientoBody">
                        <tr>
                            <td colspan="6" class="text-center text-muted">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Events Table -->
        <div class="card-translucent position-relative mt-4">
            <div id="eventosLoader" class="spinner-overlay" style="display: none;">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <h4 class="section-title">
                <i class="bi bi-folder"></i> Eventos de Carga Recientes
            </h4>
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="eventosTable">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Sucursal</th>
                            <th>Usuario</th>
                            <th>Archivo</th>
                            <th>Procesados</th>
                            <th>Total</th>
                            <th>%</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="eventosBody">
                        <tr>
                            <td colspan="8" class="text-center text-muted">Cargando eventos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Get filter parameters from page
        const urlParams = new URLSearchParams(window.location.search);
        const sucursalId = urlParams.get('sucursalId') || '';
        const fechaInicio = /*[[${fechaInicio}]]*/ '';
        const fechaFin = /*[[${fechaFin}]]*/ '';

        // Load KPIs
        async function loadKPIs() {
            try {
                const params = new URLSearchParams({ fechaInicio, fechaFin });
                if (sucursalId) params.append('sucursalId', sucursalId);

                const response = await fetch(`/api/stock/auditoria/kpis?${params}`);
                if (!response.ok) throw new Error('Error loading KPIs');

                const data = await response.json();
                document.getElementById('kpiTotalCargas').textContent = data.totalCargas;
                document.getElementById('kpiCargasExitosas').textContent = data.cargasExitosas;
                document.getElementById('kpiConErrores').textContent = data.conErrores;
                document.getElementById('kpiPromedio').textContent = data.promedioCompletado.toFixed(1) + '%';
            } catch (error) {
                console.error('Error loading KPIs:', error);
            }
        }

        // Load Compliance Data
        async function loadCumplimiento() {
            const loader = document.getElementById('cumplimientoLoader');
            const tbody = document.getElementById('cumplimientoBody');

            try {
                loader.style.display = 'flex';
                const params = new URLSearchParams({ fechaInicio, fechaFin });
                if (sucursalId) params.append('sucursalId', sucursalId);

                const response = await fetch(`/api/stock/auditoria/cumplimiento?${params}`);
                if (!response.ok) throw new Error('Error loading compliance');

                const data = await response.json();
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay datos para mostrar</td></tr>';
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(row.fecha)}</td>
                        <td>${row.sucursalNombre}</td>
                        <td>${row.diaEsperado}</td>
                        <td><strong>${row.cantidadCargas}</strong></td>
                        <td>
                            ${row.estadoVolumen
                            ? '<i class="bi bi-check-circle-fill text-success"></i> OK'
                            : '<i class="bi bi-exclamation-triangle-fill text-warning"></i> Bajo'}
                        </td>
                        <td>
                            <span class="compliance-badge ${row.cumpleRegla ? 'badge-cumple' : 'badge-no-cumple'}">
                                ${row.cumpleRegla ? 'âœ“ CUMPLE' : 'âœ— NO CUMPLE'}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading compliance:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar datos</td></tr>';
            } finally {
                loader.style.display = 'none';
            }
        }

        // Load Events
        async function loadEventos() {
            const loader = document.getElementById('eventosLoader');
            const tbody = document.getElementById('eventosBody');

            try {
                loader.style.display = 'flex';
                const params = new URLSearchParams({ fechaInicio, fechaFin });
                if (sucursalId) params.append('sucursalId', sucursalId);

                const response = await fetch(`/api/stock/auditoria/eventos?${params}`);
                if (!response.ok) throw new Error('Error loading events');

                const data = await response.json();
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay eventos para mostrar</td></tr>';
                    return;
                }

                data.forEach(event => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDateTime(event.fecha)}</td>
                        <td>${event.sucursalNombre}</td>
                        <td>${event.usuario}</td>
                        <td><small>${event.nombreArchivo}</small></td>
                        <td>${event.procesados.toLocaleString()}</td>
                        <td>${event.totalRegistros.toLocaleString()}</td>
                        <td><strong>${event.porcentaje}%</strong></td>
                        <td>
                            <span class="estado-badge ${getEstadoBadgeClass(event.estado)}">
                                ${event.estado}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading events:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar eventos</td></tr>';
            } finally {
                loader.style.display = 'none';
            }
        }

        // Helper functions
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            // Use T00:00:00 to force local timezone parsing and avoid UTC shifts
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit' }) + ' ' +
                date.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        }

        function getEstadoBadgeClass(estado) {
            switch (estado) {
                case 'COMPLETADO':
                    return 'badge bg-success';
                case 'EN_PROCESO':
                    return 'badge bg-primary';
                case 'ERROR':
                case 'FALLIDO':
                    return 'badge bg-danger';
                default:
                    return 'badge bg-secondary';
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            Promise.all([
                loadKPIs(),
                loadCumplimiento(),
                loadEventos()
            ]).then(() => {
                console.log('âœ… All audit data loaded');
            }).catch(error => {
                console.error('âŒ Error loading audit dashboard:', error);
            });
        });
        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>

</html>