<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Carga de archivos Excel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dropzone {
            border: 2px dashed #0d6efd;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .dropzone:hover {
            background: #e9f0ff;
        }

        .dz-message {
            font-weight: 500;
            color: #6c757d;
        }

        pre#resultado {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f1f1f1;
        }
        body {
          background: url('/recursos/img8.jpg') no-repeat center center fixed;
          background-image: url('/home/ubuntu/img8.jpg') no-repeat center center fixed;
          background-size: cover;
          background-position: center;
          background-attachment: fixed;
          min-height: 100vh;
        }

/* Botones secundarios por mÃ³dulo */
.stock-1 { background-color: #0097a7; color: white; }
.stock-2 { background-color: #00bcd4; color: white; }
.stock-3 { background-color: #80deea; color: black; }
.stock-4 { background-color: #b2ebf2; color: black; }

.caja-1 { background-color: #ffa726; color: black; }
.caja-2 { background-color: #ffb74d; color: black; }
.caja-3 { background-color: #ffcc80; color: black; }
.caja-4 { background-color: #ffe0b2; color: black; }

.pedido-1 { background-color: #9575cd; color: white; }
.pedido-2 { background-color: #b39ddb; color: white; }
.pedido-3 { background-color: #d1c4e9; color: black; }
.pedido-4 { background-color: #ede7f6; color: black; }



         #miDropzone { min-height: 180px; padding: 30px; border: 2px dashed #0d6efd; background: #f8f9fa; border-radius: 10px; }
  #miDropzone:hover { background: #e9f0ff; }
  #miDropzone .dz-message { margin: 0; }
    </style>
</head>
<body class="bg-light">
<header th:replace="plantillas/plantilla::header"></header>
<div class="volver-fijo d-flex justify-content-end px-4 pt-3">
    <a th:href="@{/menuPrincipal}" class="btn btn-primary btn-lg">
        <i class="bi bi-arrow-left-circle"></i> Volver
    </a>
</div>
<div class="container py-5">
    <div class="card shadow-lg border-0">
        <div th:class="|card-header text-center mb-4 ${colorClase}|">
            <h2 class="fw-bold" th:text="${pantalla}">ðŸ“Š Carga de Archivos de </h2>
        </div>
        <div class="card-body">

            <div class="mb-4 row">
                <div class="col-md-6">
                    <label for="sucursalSelect" class="form-label fw-semibold">Seleccione la sucursal:</label>
                    <select id="sucursalSelect" class="form-select">
                        <option value="">-- Seleccione una sucursal --</option>
                        <option th:each="s : ${sucursales}" th:value="${s.id}" th:text="${s.nombre}"></option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="fechaStock" class="form-label fw-semibold">Fecha del stock:</label>
                    <input type="date"
                           id="fechaStock"
                           class="form-control"
                           th:value="${#dates.format(ahora, 'yyyy-MM-dd')}"
                           th:attr="max=${#dates.format(ahora, 'yyyy-MM-dd')}">
                    <div id="fechaError" class="text-danger mt-1" style="display: none;">
                        La fecha no puede ser futura.
                    </div>
                </div>
            </div>

            <!-- Dropzone -->
            <form action="/subirArchivosExcel" class="dropzone text-center" id="miDropzone">
                <input type="hidden" name="sucursalId" id="sucursalIdHidden"/>
                <div class="dz-message needsclick">
                    <i class="bi bi-cloud-arrow-up display-4 text-primary"></i>
                    <p class="mt-2">Suelta tus archivos aquÃ­ o haz clic para seleccionarlos</p>
                </div>
            </form>

            <div class="mt-4">
                <label class="fw-semibold mb-2">ðŸ“„ Resultados:</label>
                <pre id="resultado" class="border p-3 rounded"></pre>
            </div>
        </div>
    </div>

</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
<script>
    function validarFechaStock() {
        const fechaInput = document.getElementById("fechaStock");
        const fechaSeleccionada = new Date(fechaInput.value);
        const hoy = new Date();
        // Normalizamos ambas fechas a medianoche para comparar solo la fecha
        hoy.setHours(0, 0, 0, 0);
        fechaSeleccionada.setHours(0, 0, 0, 0);

        if (fechaSeleccionada > hoy) {
            document.getElementById("fechaError").style.display = "block";
            return false;
        } else {
            document.getElementById("fechaError").style.display = "none";
            return true;
        }
    }
    Dropzone.autoDiscover = false;

    const dz = new Dropzone("#miDropzone", {
      url: "/subirArchivosExcel",
      method: "post",
      paramName: "file",
      autoProcessQueue: false,
      uploadMultiple: false,
      parallelUploads: 1,
      maxFilesize: 10,
      acceptedFiles: ".xls,.xlsx",
      clickable: "#miDropzone",
      addRemoveLinks: true,
      dictDefaultMessage: "Arrastra los archivos aquÃ­ o haz clic para seleccionar",
      dictRemoveFile: "âŒ Quitar",
      init: function () {
        this.on("addedfile", (file) => {
          const sel = document.getElementById("sucursalSelect");
          const sucursalId = sel.value;
          const sucursalText = sel.options[sel.selectedIndex]?.text || "";

          if (!sucursalId) {
            Swal.fire("âš ï¸ AtenciÃ³n", "Debe seleccionar una sucursal antes de subir archivos", "warning");
            this.removeFile(file);
            return;
          }
          if (!validarFechaStock()) {
            Swal.fire("âš ï¸ AtenciÃ³n", "La fecha del stock no puede ser futura.", "warning");
            this.removeFile(file);
            return;
          }

          document.getElementById("sucursalIdHidden").value = sucursalId;

          Swal.fire({
            title: "Confirmar sucursal",
            text: `El archivo serÃ¡ cargado para la sucursal: ${sucursalText}. Â¿Desea continuar?`,
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "SÃ­, continuar",
            cancelButtonText: "Cancelar"
          }).then((result) => {
            if (result.isConfirmed) {
              // ðŸ‘‰ simular barra lenta al 80%
              const progress = file.previewElement.querySelector("[data-dz-uploadprogress]");
              if (progress) {
                progress.style.width = "80%";
              }

              Swal.fire({
                title: "Procesando...",
                text: "Procesando archivo",
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
              });

              this.processFile(file);
            } else {
              this.removeFile(file);
            }
          });
        });

        // Adjuntar sucursalId en el envÃ­o
        this.on("sending", (file, xhr, formData) => {
          const sucursalId = document.getElementById("sucursalSelect").value;
          const fechaStock = document.getElementById("fechaStock").value;
          formData.append("sucursalId", sucursalId);
          formData.append("fechaStock", fechaStock);
        });

        // âœ… Ã©xito
        this.on("success", (file, response) => {
          Swal.close();
          const msg = (response && response.mensaje) ? response.mensaje : "âœ… Archivo procesado correctamente.";
          document.getElementById("resultado").textContent += msg + "\n";

          const progress = file.previewElement.querySelector("[data-dz-uploadprogress]");
          if (progress) progress.style.width = "100%";

          setTimeout(() => this.removeFile(file), 800);
        });

        this.on("error", (file, errorMessage, xhr) => {
          Swal.close();
          let mensaje = "âŒ Error al subir el archivo.";
          if (xhr && xhr.responseText) {
            try { mensaje = JSON.parse(xhr.responseText).mensaje || xhr.responseText; }
            catch { mensaje = xhr.responseText; }
          } else if (typeof errorMessage === "string") {
            mensaje = errorMessage;
          }
          document.getElementById("resultado").textContent += mensaje + "\n";

          // ðŸ‘‡ limpiar el recuadro si falla
          setTimeout(() => this.removeFile(file), 1000);
        });
      }
    });
</script>


</body>
</html>
